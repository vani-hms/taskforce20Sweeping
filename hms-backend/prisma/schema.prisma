generator client {
  provider   = "prisma-client-js"
  output     = "../generated/prisma"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model HMS {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now())
  cities    City[]
}

model City {
  id                    String                    @id @default(uuid()) @db.Uuid
  hmsId                 String
  name                  String
  code                  String                    @unique
  createdAt             DateTime                  @default(now())
  enabled               Boolean                   @default(true)
  ulbCode               String?
  hms                   HMS                       @relation(fields: [hmsId], references: [id], onDelete: Cascade)
  modules               CityModule[]
  zones                 GeoNode[]
  iecForms              IECForm[]
  permissions           Permission[]
  sweepingRecords       SweepingRecord[]
  taskforceActivities   TaskforceActivity[]
  taskforceCases        TaskforceCase[]
  taskforceRecords      TaskforceRecord[]
  taskforceFeederPoints TaskforceFeederPoint[]
  litterBins            LitterBin[]
  litterBinRecords      LitterBinRecord[]
  litterBinVisitReports LitterBinVisitReport[]
  litterBinReports      LitterBinReport[]
  users                 UserCity[]
  moduleRoles           UserModuleRole[]
  registrationRequests  UserRegistrationRequest[]
  TaskforceFeederReport TaskforceFeederReport[]
  toilets               Toilet[]
  toiletInspections     ToiletInspection[]
  toiletAssignments     ToiletAssignment[]

  @@index([hmsId])
}

model Module {
  id                  String              @id @default(uuid())
  name                String              @unique
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  displayName         String?
  cityModules         CityModule[]
  iecForms            IECForm[]
  permissions         Permission[]
  taskforceActivities TaskforceActivity[]
  taskforceCases      TaskforceCase[]
  userModuleRoles     UserModuleRole[]
}

model CityModule {
  id        String   @id @default(uuid())
  cityId    String   @db.Uuid
  moduleId  String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  module    Module   @relation(fields: [moduleId], references: [id])

  @@unique([cityId, moduleId])
  @@index([cityId, moduleId])
}

model User {
  id                              String                  @id @default(uuid()) @db.Uuid
  email                           String                  @unique
  name                            String
  password                        String
  createdAt                       DateTime                @default(now())
  updatedAt                       DateTime                @updatedAt
  sweepingRecords                 SweepingRecord[]
  taskforceRecords                TaskforceRecord[]
  taskforceFeederPointsApproved   TaskforceFeederPoint[]  @relation("TaskforceFeederApprovedBy")
  taskforceFeederPointsRequested  TaskforceFeederPoint[]  @relation("TaskforceFeederRequestedBy")
  taskforceFeederReportsSubmitted TaskforceFeederReport[] @relation("TaskforceReportSubmittedBy")
  taskforceFeederReportsReviewed  TaskforceFeederReport[] @relation("TaskforceReportReviewedBy")
  twinbinLitterBinsApproved       LitterBin[]             @relation("TwinbinApprovedBy")
  twinbinLitterBinsRequested      LitterBin[]             @relation("TwinbinRequestedBy")
  twinbinRecords                  LitterBinRecord[]
  twinbinVisitActions             LitterBinVisitReport[]  @relation("TwinbinVisitActionTakenBy")
  twinbinVisitsReviewed           LitterBinVisitReport[]  @relation("TwinbinVisitReviewedBy")
  twinbinVisitsSubmitted          LitterBinVisitReport[]  @relation("TwinbinVisitSubmittedBy")
  twinbinReportsSubmitted         LitterBinReport[]       @relation("TwinbinReportSubmittedBy")
  twinbinReportsReviewed          LitterBinReport[]       @relation("TwinbinReportReviewedBy")
  toiletsRequested                Toilet[]                @relation("ToiletRequestedBy")
  toiletInspections               ToiletInspection[]      @relation("ToiletInspectionBy")
  toiletAssignments               ToiletAssignment[]      @relation("ToiletAssignmentTo")
  cities                          UserCity[]
  modules                         UserModuleRole[]
}

model UserCity {
  id        String   @id @default(uuid())
  userId    String   @db.Uuid
  cityId    String   @db.Uuid
  role      Role
  createdAt DateTime @default(now())
  zoneIds   String[] @default([])
  wardIds   String[] @default([])
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, cityId, role])
  @@index([cityId, role])
}

model UserModuleRole {
  id        String   @id @default(uuid())
  userId    String   @db.Uuid
  cityId    String   @db.Uuid
  moduleId  String
  role      Role
  createdAt DateTime @default(now())
  canWrite  Boolean  @default(false)
  zoneIds   String[] @default([])
  wardIds   String[] @default([])
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, cityId, moduleId, role])
  @@index([cityId, moduleId, role])
}

model Permission {
  id        String   @id @default(uuid())
  cityId    String   @db.Uuid
  moduleId  String?
  role      Role
  resource  String
  action    String
  createdAt DateTime @default(now())
  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  module    Module?  @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([cityId, moduleId, role])
  @@index([cityId, resource, action])
}

model GeoNode {
  id             String          @id @default(uuid())
  cityId         String          @db.Uuid
  parentId       String?
  level          GeoLevel
  name           String
  path           String
  createdAt      DateTime        @default(now())
  areaType       AreaType?
  city           City            @relation(fields: [cityId], references: [id], onDelete: Cascade)
  parent         GeoNode?        @relation("GeoChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children       GeoNode[]       @relation("GeoChildren")
  taskforceCases TaskforceCase[]

  @@index([cityId, level])
  @@index([cityId, path])
}

model TaskforceCase {
  id         String              @id @default(uuid())
  cityId     String              @db.Uuid
  moduleId   String
  geoNodeId  String?
  title      String
  status     String
  assignedTo String?
  createdBy  String
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  activities TaskforceActivity[]
  city       City                @relation(fields: [cityId], references: [id], onDelete: Cascade)
  geoNode    GeoNode?            @relation(fields: [geoNodeId], references: [id])
  module     Module              @relation(fields: [moduleId], references: [id])

  @@index([cityId, status])
  @@index([cityId, geoNodeId])
}

model TaskforceActivity {
  id        String        @id @default(uuid())
  cityId    String        @db.Uuid
  moduleId  String
  caseId    String
  actorId   String
  action    String
  metadata  Json?
  createdAt DateTime      @default(now())
  case      TaskforceCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  city      City          @relation(fields: [cityId], references: [id], onDelete: Cascade)
  module    Module        @relation(fields: [moduleId], references: [id])

  @@index([cityId, caseId])
}

model IECForm {
  id          String    @id @default(uuid())
  cityId      String    @db.Uuid
  moduleId    String
  title       String
  description String?
  status      IECStatus @default(DRAFT)
  submittedBy String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  city        City      @relation(fields: [cityId], references: [id], onDelete: Cascade)
  module      Module    @relation(fields: [moduleId], references: [id])

  @@index([cityId, status])
  @@index([cityId, moduleId])
}

model SweepingRecord {
  id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cityId        String             @db.Uuid
  createdBy     String             @db.Uuid
  status        ModuleRecordStatus @default(DRAFT)
  payload       Json
  areaType      AreaType
  createdAt     DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  city          City               @relation(fields: [cityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdByUser User               @relation(fields: [createdBy], references: [id], onUpdate: NoAction)

  @@index([cityId])
}

model LitterBinRecord {
  id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cityId        String             @db.Uuid
  createdBy     String             @db.Uuid
  status        ModuleRecordStatus @default(DRAFT)
  payload       Json
  createdAt     DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  city          City               @relation(fields: [cityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdByUser User               @relation(fields: [createdBy], references: [id], onUpdate: NoAction)

  @@index([cityId])
  @@map("LitterBinRecord")
}

model LitterBin {
  id                  String                 @id @default(uuid()) @db.Uuid
  cityId              String                 @db.Uuid
  requestedById       String                 @db.Uuid
  zoneId              String?                @db.Uuid
  wardId              String?                @db.Uuid
  areaName            String
  areaType            AreaType
  locationName        String
  roadType            String
  isFixedProperly     Boolean
  hasLid              Boolean
  condition           BinCondition
  latitude            Float
  longitude           Float
  status              TwinbinBinStatus
  assignedEmployeeIds String[]               @default([])
  approvedByQcId      String?                @db.Uuid
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  approvedByQc        User?                  @relation("TwinbinApprovedBy", fields: [approvedByQcId], references: [id])
  city                City                   @relation(fields: [cityId], references: [id], onDelete: Cascade)
  requestedBy         User                   @relation("TwinbinRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  visits              LitterBinVisitReport[]
  reports             LitterBinReport[]

  @@index([cityId])
  @@map("LitterBin")
}

model LitterBinVisitReport {
  id                String             @id @default(uuid()) @db.Uuid
  cityId            String             @db.Uuid
  binId             String             @db.Uuid
  submittedById     String             @db.Uuid
  visitedAt         DateTime
  latitude          Float
  longitude         Float
  distanceMeters    Float
  inspectionAnswers Json
  status            TwinbinVisitStatus @default(PENDING_QC)
  actionStatus      ReportActionStatus @default(APPROVED)
  qcRemark          String?
  actionTakenById   String?            @db.Uuid
  actionRemark      String?
  actionPhotoUrl    String?
  actionTakenAt     DateTime?
  reviewedByQcId    String?            @db.Uuid
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  actionTakenBy     User?              @relation("TwinbinVisitActionTakenBy", fields: [actionTakenById], references: [id])
  bin               LitterBin          @relation(fields: [binId], references: [id], onDelete: Cascade)
  city              City               @relation(fields: [cityId], references: [id], onDelete: Cascade)
  reviewedByQc      User?              @relation("TwinbinVisitReviewedBy", fields: [reviewedByQcId], references: [id])
  submittedBy       User               @relation("TwinbinVisitSubmittedBy", fields: [submittedById], references: [id], onDelete: Cascade)

  @@index([cityId])
  @@index([binId])
  @@map("LitterBinVisitReport")
}

model LitterBinReport {
  id             String              @id @default(uuid()) @db.Uuid
  cityId         String              @db.Uuid
  binId          String              @db.Uuid
  submittedById  String              @db.Uuid
  reviewedByQcId String?             @db.Uuid
  status         TwinbinReportStatus
  latitude       Float
  longitude      Float
  distanceMeters Float
  questionnaire  Json
  createdAt      DateTime            @default(now())
  reviewedAt     DateTime?
  bin            LitterBin           @relation(fields: [binId], references: [id], onDelete: Cascade)
  city           City                @relation(fields: [cityId], references: [id], onDelete: Cascade)
  submittedBy    User                @relation("TwinbinReportSubmittedBy", fields: [submittedById], references: [id], onDelete: Cascade)
  reviewedByQc   User?               @relation("TwinbinReportReviewedBy", fields: [reviewedByQcId], references: [id])

  @@index([cityId])
  @@index([binId])
  @@map("LitterBinReport")
}

model TaskforceFeederPoint {
  id                  String                  @id @default(uuid()) @db.Uuid
  cityId              String                  @db.Uuid
  requestedById       String                  @db.Uuid
  zoneId              String?                 @db.Uuid
  wardId              String?                 @db.Uuid
  zoneName            String?                 @default("")
  wardName            String?                 @default("")
  areaName            String
  areaType            AreaType
  feederPointName     String
  locationDescription String
  populationDensity   String                  @default("")
  accessibilityLevel  String                  @default("")
  householdsCount     Int                     @default(0)
  vehicleType         String                  @default("")
  landmark            String                  @default("")
  photoUrl            String                  @default("")
  notes               String?                 @db.Text
  latitude            Float
  longitude           Float
  status              TaskforceRequestStatus
  assignedEmployeeIds String[]                @default([])
  approvedByQcId      String?                 @db.Uuid
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  city                City                    @relation(fields: [cityId], references: [id], onDelete: Cascade)
  requestedBy         User                    @relation("TaskforceFeederRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  approvedByQc        User?                   @relation("TaskforceFeederApprovedBy", fields: [approvedByQcId], references: [id])
  reports             TaskforceFeederReport[]

  @@index([cityId])
}

model TaskforceRecord {
  id            String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cityId        String             @db.Uuid
  createdBy     String             @db.Uuid
  status        ModuleRecordStatus @default(DRAFT)
  payload       Json
  createdAt     DateTime           @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime           @default(now()) @updatedAt @db.Timestamptz(6)
  city          City               @relation(fields: [cityId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  createdByUser User               @relation(fields: [createdBy], references: [id], onUpdate: NoAction)

  @@index([cityId])
}

model TaskforceFeederReport {
  id             String                @id @default(uuid()) @db.Uuid
  feederPointId  String                @db.Uuid
  cityId         String                @db.Uuid
  submittedById  String                @db.Uuid
  latitude       Float
  longitude      Float
  distanceMeters Float
  payload        Json
  status         TaskforceReportStatus
  reviewedByQcId String?               @db.Uuid
  reviewedAt     DateTime?
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  feederPoint    TaskforceFeederPoint  @relation(fields: [feederPointId], references: [id], onDelete: Cascade)
  city           City                  @relation(fields: [cityId], references: [id], onDelete: Cascade)
  submittedBy    User                  @relation("TaskforceReportSubmittedBy", fields: [submittedById], references: [id], onDelete: Cascade)
  reviewedByQc   User?                 @relation("TaskforceReportReviewedBy", fields: [reviewedByQcId], references: [id])

  @@index([cityId])
}

model UserRegistrationRequest {
  id               String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String
  phone            String
  aadhaar          String
  email            String
  passwordHash     String
  cityId           String             @db.Uuid
  zoneId           String?
  wardId           String?
  requestedModules String[]
  status           RegistrationStatus @default(PENDING)
  createdAt        DateTime           @default(now()) @db.Timestamptz(6)
  approvedByUserId String?            @db.Uuid
  approvedByRole   Role?
  approvedAt       DateTime?          @db.Timestamptz(6)
  rejectedByUserId String?            @db.Uuid
  rejectedByRole   Role?
  rejectedAt       DateTime?          @db.Timestamptz(6)
  rejectReason     String?
  city             City               @relation(fields: [cityId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([email, cityId])
  @@index([cityId])
}

model Toilet {
  id                  String       @id @default(uuid()) @db.Uuid
  cityId              String       @db.Uuid
  requestedById       String       @db.Uuid
  wardId              String?      @db.Uuid
  zoneId              String?      @db.Uuid
  name                String
  type                ToiletType
  gender              ToiletGender
  code                String?      @unique
  operatorName        String?
  numberOfSeats       Int?         @default(0)
  latitude            Float
  longitude           Float
  address             String?
  status              ToiletStatus @default(PENDING)
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  assignedEmployeeIds String[]     @default([])

  city        City               @relation(fields: [cityId], references: [id], onDelete: Cascade)
  requestedBy User               @relation("ToiletRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  inspections ToiletInspection[]
  assignments ToiletAssignment[]

  @@index([cityId])
}

model ToiletInspection {
  id             String           @id @default(uuid()) @db.Uuid
  cityId         String           @db.Uuid
  toiletId       String           @db.Uuid
  employeeId     String           @db.Uuid
  status         InspectionStatus @default(SUBMITTED)
  latitude       Float
  longitude      Float
  distanceMeters Float?
  answers        Json?
  qcComment      String?
  actionNote     String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  toilet   Toilet @relation(fields: [toiletId], references: [id], onDelete: Cascade)
  employee User   @relation("ToiletInspectionBy", fields: [employeeId], references: [id], onDelete: Cascade)
  city     City   @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@index([cityId])
  @@index([toiletId])
}

model ToiletAssignment {
  id         String   @id @default(uuid()) @db.Uuid
  cityId     String   @db.Uuid
  toiletId   String   @db.Uuid
  employeeId String   @db.Uuid
  category   String?
  assignedAt DateTime @default(now())

  city     City   @relation(fields: [cityId], references: [id], onDelete: Cascade)
  toilet   Toilet @relation(fields: [toiletId], references: [id], onDelete: Cascade)
  employee User   @relation("ToiletAssignmentTo", fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([toiletId, employeeId])
}

model ToiletInspectionQuestion {
  id           String      @id @default(uuid()) @db.Uuid
  text         String
  type         String      @default("YES_NO") // YES_NO, TEXT, OPTIONS
  options      String[]    @default([])
  requirePhoto Boolean     @default(false)
  forType      ToiletType? // CT, PT, or null for both
  order        Int         @default(0)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
}

enum Role {
  HMS_SUPER_ADMIN
  CITY_ADMIN
  COMMISSIONER
  ACTION_OFFICER
  EMPLOYEE
  QC
}

enum GeoLevel {
  CITY
  ZONE
  WARD
  KOTHI
  SUB_KOTHI
  GALI
  AREA
  BEAT
}

enum AreaType {
  RESIDENTIAL
  COMMERCIAL
  SLUM
}

enum ModuleRecordStatus {
  DRAFT
  SUBMITTED
  APPROVED
}

enum BinCondition {
  GOOD
  DAMAGED
}

enum TwinbinVisitStatus {
  PENDING_QC
  APPROVED
  REJECTED
}

enum TwinbinReportStatus {
  SUBMITTED
  APPROVED
  REJECTED
  ACTION_REQUIRED
}

enum ReportActionStatus {
  APPROVED
  REJECTED
  ACTION_REQUIRED
  ACTION_TAKEN
}

enum TaskforceRequestStatus {
  PENDING_QC
  APPROVED
  REJECTED
  ACTION_REQUIRED
}

enum TaskforceReportStatus {
  SUBMITTED
  APPROVED
  REJECTED
  ACTION_REQUIRED
}

enum TwinbinBinStatus {
  PENDING_QC
  APPROVED
  REJECTED
}

enum ToiletType {
  CT
  PT
}

enum ToiletGender {
  MALE
  FEMALE
  UNISEX
  DISABLED
}

enum ToiletStatus {
  PENDING
  APPROVED
  REJECTED
}

enum InspectionStatus {
  SUBMITTED
  APPROVED
  REJECTED
  ACTION_REQUIRED
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum IECStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}
